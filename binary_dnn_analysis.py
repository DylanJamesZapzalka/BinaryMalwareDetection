from models import BinaryDNN, TrivialDNN
import tensorflow as tf
import numpy as np



# Hyperparameters
LEARNING_RATE = 0.0001
EPOCHS = 48



# Create and compile the model
model = BinaryDNN()
model.compile(
    loss=tf.keras.losses.CategoricalCrossentropy(),
    optimizer=tf.keras.optimizers.Adam(learning_rate=LEARNING_RATE),
    metrics=["accuracy"]
)

# Load and prepare the data
benign_data = np.loadtxt("processed_data/cfg_features/benign.txt").astype("float32")
malicious_data = np.loadtxt("processed_data/cfg_features/malicious.txt").astype("float32")
data = np.concatenate((benign_data, malicious_data))
np.random.shuffle(data)
training_data = data[0 : int(len(data)*0.8)]
testing_data = data[int(len(data)*0.8) : len(data)]

# Split the data
x_train = np.delete(training_data, np.shape(training_data)[1]-1, 1)
y_train = training_data[:,np.shape(training_data)[1]-1]
x_test = np.delete(testing_data, np.shape(testing_data)[1]-1, 1)
y_test = testing_data[:,np.shape(testing_data)[1]-1]

# Normalize the data
mean = np.mean(x_train, axis=0)
std = np.std(x_train, axis=0)
x_train = (x_train - mean)/(std + 0.0001)
x_test = (x_test - mean)/(std + 0.0001)

# Actual values used for confusion matrix
actuals = y_test

# I didn't save the labels as vectors, so I must convert it so I can use categorical cross entropy
y_train = np.array([[1,0] if i == 1 else [0,1] for i in y_train])
y_test = np.array([[1,0] if i == 1 else [0,1] for i in y_test])

# Train the model
model.fit(x_train, y_train, batch_size=1, epochs=EPOCHS, verbose=1)



# Test the model
predictions = model.predict(x_test)
predictions = [0 if i[0] >= i[1] else 1 for i in predictions]

tpos = 0
fpos = 0
fneg = 0
tneg = 0

for i in range(len(actuals)):
    if actuals[i] ==  1 and predictions[i] == 1:
        tpos += 1
    elif actuals[i] == 0 and predictions[i] == 1:
        fpos += 1
    elif actuals[i] == 1 and predictions[i] == 0:
        fneg += 1
    else:
        tneg += 1

confusion_matrix = [[tpos, fneg], [fpos, tneg]]
print(confusion_matrix)

loss = model.evaluate(x_test, y_test, batch_size=1)
print('Test loss: {}'.format(loss))